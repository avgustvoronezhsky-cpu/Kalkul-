<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –î–¢–ü –í–æ—Ä–æ–Ω–µ–∂</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
body { font-family: Arial, sans-serif; padding: 20px; background: #f0f5f5; }
h1 { text-align: center; }
section { background: #fff; padding: 20px; border-radius: 10px; margin-bottom: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.1);}
canvas { max-width: 100%; }
table { width: 100%; border-collapse: collapse; margin-top: 10px; }
th, td { border: 1px solid #ccc; padding: 8px; }
th { background: #333; color: #fff; }
tr:nth-child(even){background:#eee;}
</style>
</head>
<body>

<h1>–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –î–¢–ü –í–æ—Ä–æ–Ω–µ–∂</h1>

<section>
  <h2>–ó–∞–≥—Ä—É–∑–∏—Ç–µ –ª–æ–∫–∞–ª—å–Ω—É—é –±–∞–∑—É –î–¢–ü (JSON)</h2>
  <input type="file" id="fileInput" accept=".json">
</section>

<section>
  <h2>–¢–æ–ø –∞–≤–∞—Ä–∏–π–Ω—ã—Ö —É–ª–∏—Ü</h2>
  <table id="streetTable">
    <thead>
      <tr><th>–£–ª–∏—Ü–∞</th><th>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –î–¢–ü</th></tr>
    </thead>
    <tbody></tbody>
  </table>
</section>

<section>
  <h2>–ì—Ä–∞—Ñ–∏–∫ –î–¢–ü –ø–æ —á–∞—Å–∞–º</h2>
  <canvas id="hoursChart"></canvas>
</section>

<section>
  <h2>–°–≤–æ–¥–∫–∞ –ø–æ —Ä–∞–π–æ–Ω–∞–º</h2>
  <table id="districtTable">
    <thead>
      <tr><th>–†–∞–π–æ–Ω</th><th>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –î–¢–ü</th></tr>
    </thead>
    <tbody></tbody>
  </table>
</section>

<script>
// ===== –ù–∞—Å—Ç—Ä–æ–π–∫–∏ Telegram =====
const BOT_TOKEN = "7540783502:AAGaCzOo4G951ECpFBeUED5_Mhk0qFdlkFI";
const CHAT_ID = "881133631";
const peakHours = [8,9,17,18,19]; // —á–∞—Å—ã –ø–∏–∫

function sendTelegram(message){
    fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`, {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({chat_id: CHAT_ID, text: message})
    }).catch(err => console.log("Telegram fetch error:", err));
}

// ===== –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ =====
function updateAnalytics(data){
    const streetCount = {};
    const hourCount = {};
    const districtCount = {};

    data.forEach(d => {
        streetCount[d.street] = (streetCount[d.street] || 0) + 1;
        districtCount[d.district] = (districtCount[d.district] || 0) + 1;
        const hour = parseInt(d.time.split(":")[0]);
        hourCount[hour] = (hourCount[hour] || 0) + 1;
    });

    // –¢–æ–ø —É–ª–∏—Ü
    const streetTable = document.querySelector("#streetTable tbody");
    streetTable.innerHTML = "";
    Object.entries(streetCount).sort((a,b)=>b[1]-a[1]).forEach(([street,count]) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${street}</td><td>${count}</td>`;
        streetTable.appendChild(tr);
    });

    // –°–≤–æ–¥–∫–∞ –ø–æ —Ä–∞–π–æ–Ω–∞–º
    const districtTable = document.querySelector("#districtTable tbody");
    districtTable.innerHTML = "";
    Object.entries(districtCount).sort((a,b)=>b[1]-a[1]).forEach(([district,count]) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${district}</td><td>${count}</td>`;
        districtTable.appendChild(tr);
    });

    // –ì—Ä–∞—Ñ–∏–∫ –ø–æ —á–∞—Å–∞–º
    const ctx = document.getElementById("hoursChart").getContext("2d");
    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: Object.keys(hourCount).sort((a,b)=>a-b),
            datasets: [{
                label: '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –î–¢–ü',
                data: Object.keys(hourCount).sort((a,b)=>a-b).map(h=>hourCount[h]),
                backgroundColor: '#2193b0'
            }]
        },
        options: { responsive: true, plugins: { legend: { display: false } } }
    });

    // Telegram —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø–æ —á–∞—Å–∞–º –ø–∏–∫
    let message = "üìä –ß–∞—Å—ã –ø–∏–∫ –î–¢–ü –í–æ—Ä–æ–Ω–µ–∂:\n";
    Object.entries(hourCount).filter(([h]) => peakHours.includes(parseInt(h)))
        .sort((a,b)=>b[1]-a[1])
        .forEach(([h,count]) => {
            message += `–ß–∞—Å ${h}:00 ‚Äî ${count} –î–¢–ü\n`;
        });
    sendTelegram(message);
}

// ===== –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞ =====
document.getElementById("fileInput").addEventListener("change", function(e){
    const file = e.target.files[0];
    const reader = new FileReader();
    reader.onload = function(event){
        const data = JSON.parse(event.target.result);
        updateAnalytics(data);
    }
    reader.readAsText(file);
});
</script>

</body>
</html>
